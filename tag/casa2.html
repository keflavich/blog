<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" type="text/css" href="https://keflavich.github.io/blog/theme/css/style.css" />
<link rel="icon" type="image/gif" href="https://keflavich.github.io/blog/theme/favicon8.ico">
<head>
    <base href="https://keflavich.github.io/blog">
        <title>Adam Ginsburg's blog - casa</title>
        <meta charset="utf-8" />
        <link href="https://keflavich.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Adam Ginsburg's blog Full Atom Feed" />
<!-- Using MathJax, with the delimiters $ -->
<!-- Conflict with pygments for the .mo and .mi -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
    styles: {
    ".MathJax .mo, .MathJax .mi": {color: "inherit !important"}},
    'div.typeset': { 'text-align': 'left'}
    },
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']],processEscapes: true}
    });
    TeX: {
        extensions: ["AMSmath.js", "AMSsymbols.js"]
    }
    MathJax.Hub.Register.StartupHook("HTML-CSS Jax Ready",function () {
    var VARIANT = MathJax.OutputJax["HTML-CSS"].FONTDATA.VARIANT;
    VARIANT["normal"].fonts.unshift("MathJax_SansSerif");
    VARIANT["bold"].fonts.unshift("MathJax_SansSerif-bold");
    VARIANT["italic"].fonts.unshift("MathJax_SansSerif-italic");
    VARIANT["-tex-mathit"].fonts.unshift("MathJax_SansSerif-italic");
    });
    MathJax.Hub.Register.StartupHook("SVG Jax Ready",function () {
    var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;
    VARIANT["normal"].fonts.unshift("MathJax_SansSerif");
    VARIANT["bold"].fonts.unshift("MathJax_SansSerif-bold");
    VARIANT["italic"].fonts.unshift("MathJax_SansSerif-italic");
    VARIANT["-tex-mathit"].fonts.unshift("MathJax_SansSerif-italic");
    });
</script>

<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
        
</head>

<body id="base" class="home">


    <header id="banner" class="body" >
        <div id="header" style='background-image: url("https://keflavich.github.io/blog/images/GC_4096sq_bolo.png"); background-position:left; min-heigt: 200px;  background-repeat: no-repeat; max-width: 80%;'>
            <h1 style="color: #C4C4C4;"><a class="header" href="https://keflavich.github.io/blog">Adam Ginsburg's blog <strong></strong></a></h1>

            <nav id="menu"><ul id="menulist">
                <li><a href="https://www.adamgginsburg.com">Homepage</a></li>
                <li><a href="/index.html">Blog Index</a></li>
                <li><a href="/category/bgps.html">BGPS Blog</a></li>
                <li><a href="/category/publications.html">Publications</a></li>
                <li><a href="/archives.html">Archives</a></li>
                <li><a href="/tags.html">Tags</a></li>
            </ul></nav><!-- /#menu -->
        </div>
    </header><!-- /#banner -->

  <div id="sidebar">
    <ul>
      <li>
        <h3 id='recent_header'>Recent Posts</h3>
        <ul>
              <li class="post">
                  2023/08/11
                  <br>
                  <a href="https://keflavich.github.io/blog/editing-metadata-in-measurement-sets.html">Editing metadata in measurement sets</a>
              </li>
              <li class="post">
                  2022/05/06
                  <br>
                  <a href="https://keflavich.github.io/blog/casa-mpi-debugging-contd.html">CASA MPI debugging cont'd</a>
              </li>
              <li class="post">
                  2022/04/11
                  <br>
                  <a href="https://keflavich.github.io/blog/hacking-plotms-to-let-pipeline-run.html">Hacking plotms to let pipeline run</a>
              </li>
              <li class="post">
                  2022/01/23
                  <br>
                  <a href="https://keflavich.github.io/blog/casa-mpi-errors-continued-in-early-2022.html">CASA MPI Errors continued in early 2022</a>
              </li>
              <li class="post">
                  2021/12/08
                  <br>
                  <a href="https://keflavich.github.io/blog/casa-errors-encountered-while-imaging-lb-data.html">CASA Errors encountered while imaging LB data</a>
              </li>
        </ul>
      </li>
    
    </ul>
  </div><!-- end #sidebar -->

  <div id="content">
<section id="content">

<ul id="post-list">
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/casas-plotms-in-a-notebook.html" rel="bookmark" title="Permalink to casa's plotms in a notebook">
                    casa's plotms in a notebook</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2021-06-14T12:30:00-06:00"> 2021/06/14 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>CASA's plotms requires an X11 frontend to work properly, so you either need to run it with xvfb or
with X.</p>
<p>I want to just make UV data plots in jupyter notebooks.</p>
<p>This is harder than it sounds, particularly for concatenated data sets.</p>
<p>First step is that you need to assemble the metadata:</p>
<div class="highlight"><pre><span></span><span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scvis</span><span class="p">)</span>
<span class="n">scsum</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>The resulting <tt class="docutils literal">scsum</tt> is a nested dictionary containing a ton of information.
We need only some of it.</p>
<p>To get out some flattened information, such as the &quot;data description IDs&quot; associated
with data that are actually in my concatenated MS (in my case, 8 of 11 observation blocks
in the metadata are not present in the data), this tool gets and flattens the resulting
information:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">walk_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">summary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">walk_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="n">kk</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">result</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span>
</pre></div>
<p>Then we grab the usable observation and data description IDs:</p>
<div class="highlight"><pre><span></span><span class="n">obsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scsum</span> <span class="k">if</span> <span class="s1">&#39;observationID&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">scsum</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="p">{}]</span>
<span class="n">ddids</span> <span class="o">=</span> <span class="n">walk_summary</span><span class="p">(</span><span class="n">scsum</span><span class="p">,</span> <span class="s1">&#39;data description IDs&#39;</span><span class="p">)</span>
</pre></div>
<p>Now we have to load the actual data.  I needed to create new versions of the <tt class="docutils literal">mstool</tt> each time
because I was getting weird errors where <tt class="docutils literal">ms.close()</tt> followed by <tt class="docutils literal">ms.open(fn)</tt> was not properly
resetting, which resulted in <tt class="docutils literal">ms.getdata</tt> returning the same data for two different MSes - BAD!</p>
<div class="highlight"><pre><span></span><span class="n">ms6</span> <span class="o">=</span> <span class="n">mstool</span><span class="p">()</span>
<span class="n">ms6</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">scvis</span><span class="p">)</span>
<span class="n">scdata_all</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ddid</span> <span class="ow">in</span> <span class="n">ddids</span><span class="p">:</span>
    <span class="n">ms6</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">ddid</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ms6</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">ddid</span><span class="p">)</span>
    <span class="n">scdata_all</span><span class="p">[</span><span class="n">ddid</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms6</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;uvdist&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_info&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_amplitude&#39;</span><span class="p">],</span> <span class="n">ifraxis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ms6</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>Then plotting is a hassle, but at least is not insane - it's just normal array manipulation:</p>
<div class="highlight"><pre><span></span><span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scdata_all</span><span class="p">:</span> <span class="c1"># the keys are SPW numbers from the multi-MS file</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">scdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
    <span class="n">uvd</span> <span class="o">=</span> <span class="n">scdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;uvdist&#39;</span><span class="p">]</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">uvd</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">weight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uvd</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UV Distance (m)&quot;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weight&quot;</span><span class="p">)</span>
</pre></div>
<p>That is basically equivalent to <tt class="docutils literal">plotms(vis, <span class="pre">xaxis='uvdist',</span> <span class="pre">yaxis='weight',</span> <span class="pre">coloraxis='spw')</span></tt>.  It's just slightly more flexible, since
you can also make waterfall plots, etc.</p>
<p>Selecting along various axes, like antenna, gets tricky.  You'd rather not go back to <tt class="docutils literal">ms.getdata</tt> because it is _slow_.</p>
<p>The &quot;identifying baselines&quot; step that you can do in plotms can be achieved through normal boolean array selection, with a result that's somewhat easier to read than CASA's logger:</p>
<div class="highlight"><pre><span></span><span class="n">highwt</span> <span class="o">=</span> <span class="p">(</span><span class="n">scdata_all</span><span class="p">[</span><span class="mi">56</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e5</span><span class="p">)</span>
<span class="n">scdata_all</span><span class="p">[</span><span class="mi">56</span><span class="p">][</span><span class="s1">&#39;axis_info&#39;</span><span class="p">][</span><span class="s1">&#39;ifr_axis&#39;</span><span class="p">][</span><span class="s1">&#39;ifr_name&#39;</span><span class="p">][</span><span class="n">highwt</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))]</span>
<span class="c1"># array([&#39;DA41-DV12&#39;, &#39;DA42-DV12&#39;, &#39;DA43-DV12&#39;, &#39;DA44-DV12&#39;, &#39;DA45-DV12&#39;,</span>
<span class="c1">#  &#39;DA46-DV12&#39;, &#39;DA47-DV12&#39;, &#39;DA48-DV12&#39;, &#39;DA49-DV12&#39;, &#39;DA50-DV12&#39;,</span>
<span class="c1">#  &#39;DA51-DV12&#39;, &#39;DA52-DV12&#39;, &#39;DA53-DV12&#39;, &#39;DA54-DV12&#39;, &#39;DA55-DV12&#39;,</span>
<span class="c1">#  &#39;DA56-DV12&#39;, &#39;DA57-DV12&#39;, &#39;DA58-DV12&#39;, &#39;DA60-DV12&#39;, &#39;DA61-DV12&#39;,</span>
<span class="c1">#  &#39;DA62-DV12&#39;, &#39;DA63-DV12&#39;, &#39;DA64-DV12&#39;, &#39;DA65-DV12&#39;, &#39;DV01-DV12&#39;,</span>
<span class="c1">#  &#39;DV02-DV12&#39;, &#39;DV03-DV12&#39;, &#39;DV04-DV12&#39;, &#39;DV05-DV12&#39;, &#39;DV06-DV12&#39;,</span>
<span class="c1">#  &#39;DV07-DV12&#39;, &#39;DV08-DV12&#39;, &#39;DV09-DV12&#39;, &#39;DV10-DV12&#39;, &#39;DV11-DV12&#39;,</span>
<span class="c1">#  &#39;DV12-DV14&#39;, &#39;DV12-DV16&#39;, &#39;DV12-DV17&#39;, &#39;DV12-DV19&#39;, &#39;DV12-DV20&#39;,</span>
<span class="c1">#  &#39;DV12-DV21&#39;, &#39;DV12-DV22&#39;, &#39;DV12-DV23&#39;, &#39;DV12-DV24&#39;, &#39;DV12-DV25&#39;],</span>
<span class="c1"># dtype=&#39;&lt;U16&#39;)</span>
</pre></div>
<p>in this case, the output shows that DV12 is clearly the antenna that's overweighted.</p>
<p>Handling flags is tricky.  The 'weight' array has shape <tt class="docutils literal">[2,nbaseline,ntime]</tt>, but I don't know if that 2 refers to frequency
or polarization, since I have two of each and there is no information about this in the <tt class="docutils literal">axis_info</tt> dictionary.  So... I'm
doing the conservative thing and ignoring any row of frequency or polarization if _any_ of the data are flagged.</p>
<div class="highlight"><pre><span></span><span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scdata_all</span><span class="p">:</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">scdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
    <span class="n">uvd</span> <span class="o">=</span> <span class="n">scdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;uvdist&#39;</span><span class="p">]</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">scdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
    <span class="n">okflag</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">uvd</span><span class="p">[</span><span class="n">okflag</span><span class="p">],</span> <span class="n">weight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uvd</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">okflag</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">:],</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">_</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UV Distance (m)&quot;</span><span class="p">)</span>
<span class="n">_</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weight&quot;</span><span class="p">)</span>
</pre></div>
<p>And, indeed, doing this revealed that the super-high-weight antenna was already flagged out.</p>
<p>This has been a demo of how to do some stuff with CASA to replicate plotms</p>
<div class="section" id="errors">
<h2>Errors</h2>
<p>Along the way, I hit a ton of errors I didn't understand, so I need a record of what they mean.</p>
<div class="section" id="data-shape-varies-selecting-first-data-desc-id-only">
<h3>&quot;Data shape varies, selecting first data desc id only&quot;</h3>
<p>This is the worst.  It means that you have a multi-ms file (mms) that has been produced by <tt class="docutils literal">concat</tt>.  It is therefore doing something <em>explicitly wrong</em> and returning only the first data description ID.</p>
<p>Data description IDs are super counterintuitive.  They refer, afaict, to SPW numbers.  If you have an MMS with unmerged SPWs (same frequency, but you didn't merge them because of tolerances or something),
each SPW will correspond to a single observation ID.</p>
<p>The solution is to explicitly <tt class="docutils literal">ms.selectinit</tt>, i.e.:</p>
<div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">datadescid</span><span class="p">)</span> <span class="c1"># note: &quot;reset=True&quot; appears to _override_ the selection</span>
<span class="n">ms</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1"># use this as needed</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>but <tt class="docutils literal">datadescid</tt> is _not_ the observation ID.  It's just... some number you need to get from the metadata.</p>
</div>
<div class="section" id="mismatched-data-shapes-when-comparing-two-mses">
<h3>Mismatched data shapes when comparing two MSes</h3>
<p>I got into this whole thing because I wanted to compare the data in two MSes to determine where we went wrong (we did go wrong).</p>
<p>Unfortunately, somewhere along the way, the autocorrelations got dropped.  I don't know how it happened because I never did it
(but I wish I had earlier), but that means that now the data shapes are mismatched.</p>
<p>The solution was to use <tt class="docutils literal">ms.select</tt> and explicitly downselect to the baselines from MS #1 in MS #2 using MS #1's <tt class="docutils literal">axis_info</tt>: <tt class="docutils literal">{'ifr_number': <span class="pre">scdata['axis_info']['ifr_axis']['ifr_number']}</span></tt>:</p>
<div class="highlight"><pre><span></span><span class="n">ms3</span> <span class="o">=</span> <span class="n">mstool</span><span class="p">()</span>
<span class="n">ms3</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newvis</span><span class="p">)</span>
<span class="n">ms3</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="c1"># 80? what the hell kind of datadescid is that?!</span>
<span class="n">ms3</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s1">&#39;ifr_number&#39;</span><span class="p">:</span> <span class="n">scdata</span><span class="p">[</span><span class="s1">&#39;axis_info&#39;</span><span class="p">][</span><span class="s1">&#39;ifr_axis&#39;</span><span class="p">][</span><span class="s1">&#39;ifr_number&#39;</span><span class="p">]})</span>
<span class="n">newdata</span> <span class="o">=</span> <span class="n">ms3</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;uvdist&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_info&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_amplitude&#39;</span><span class="p">],</span> <span class="n">ifraxis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ms3</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">newdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
<p>That downselected the baselines to match the baselines present in <tt class="docutils literal">scdata</tt>, which was MS 1.</p>
</div>
<div class="section" id="the-wrong-data-are-showing-up-when-i-open-a-new-ms">
<h3>The wrong data are showing up when I open a new MS</h3>
<p>I was comparing several MSes, and sometimes the data looked the same for MSes I was <em>dead certain</em> were different.
I was right, and the problem was apparently reusing the ms tool.</p>
<p>I didn't show the import statement above, but it was this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">ms</span><span class="p">,</span> <span class="n">msmetadata</span>
<span class="n">mstool</span> <span class="o">=</span> <span class="n">ms</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span><span class="p">()</span>
<span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
</pre></div>
<p>If I tried to reuse <tt class="docutils literal">ms</tt> as normal, like so:</p>
<div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis1</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="n">data1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis2</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>then I can't say exactly what <tt class="docutils literal">data1</tt> and <tt class="docutils literal">data2</tt> are, but they weren't the same.</p>
<p>So, instead, I created a new <tt class="docutils literal">mstool</tt> instance each time:</p>
<div class="highlight"><pre><span></span><span class="n">ms</span> <span class="o">=</span> <span class="n">mstool</span><span class="p">()</span>
<span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis1</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="n">data1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">ms</span> <span class="o">=</span> <span class="n">mstool</span><span class="p">()</span>
<span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis2</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="put-all-together">
<h2>Put all together...</h2>
<p>Here's some code to loop over a list of MSes and plot both amp and weight vs. uvdist for the field W43-MM3.</p>
<p>Of course this crashed immediately because it exceeded the available memory.</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">vissum</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">vobsids</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vissum</span> <span class="k">if</span> <span class="s1">&#39;observationID&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">vissum</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="p">{}]</span>
    <span class="n">vddids</span> <span class="o">=</span> <span class="n">walk_summary</span><span class="p">(</span><span class="n">vissum</span><span class="p">,</span> <span class="s1">&#39;data description IDs&#39;</span><span class="p">)</span>
    <span class="n">fids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vissum</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W43-MM3&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;obsids: </span><span class="si">{</span><span class="n">vobsids</span><span class="si">}</span><span class="s2">, ddids: </span><span class="si">{</span><span class="n">vddids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ms</span> <span class="o">=</span> <span class="n">mstool</span><span class="p">()</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">msdata_all</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ddid</span> <span class="ow">in</span> <span class="n">vddids</span><span class="p">:</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">ddid</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">ddid</span><span class="p">)</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s1">&#39;field_id&#39;</span><span class="p">:</span> <span class="n">fids</span><span class="p">})</span>
        <span class="n">msdata_all</span><span class="p">[</span><span class="n">ddid</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;uvdist&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_info&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_amplitude&#39;</span><span class="p">],</span> <span class="n">ifraxis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">msdata_all</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">msdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
        <span class="n">uvd</span> <span class="o">=</span> <span class="n">msdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;uvdist&#39;</span><span class="p">]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">msdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
        <span class="n">okflag</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">uvd</span><span class="p">[</span><span class="n">okflag</span><span class="p">],</span> <span class="n">weight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uvd</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">okflag</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">:],</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">_</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UV Distance (m)&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weight&quot;</span><span class="p">)</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">msdata_all</span><span class="p">:</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">msdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span>
        <span class="n">uvd</span> <span class="o">=</span> <span class="n">msdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;uvdist&#39;</span><span class="p">]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">msdata_all</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
        <span class="n">okflag</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">uvd</span><span class="p">[</span><span class="n">okflag</span><span class="p">],</span> <span class="n">amp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uvd</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">okflag</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">:],</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">_</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UV Distance (m)&quot;</span><span class="p">)</span>
    <span class="n">_</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
</pre></div>
</div>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/casa-logfiles-tclean-from-pysynthesisimager.html" rel="bookmark" title="Permalink to CASA: Logfiles & tclean from pysynthesisimager">
                    CASA: Logfiles &amp; tclean from pysynthesisimager</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2020-05-09T14:59:00-06:00"> 2020/05/09 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>A few brief notes I don't want to forget, so I'm posting them here:</p>
<p>The name of the log file being used by the currently active CASA session is in <tt class="docutils literal">casalog.logfile()</tt>.</p>
<p>I'm trying to get the pysynthesisimager version of tclean to work.  This is, in
theory, &quot;exactly the same thing as tclean&quot;, except you (the user) have the
ability to control individual steps.  The process is documented in the <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-task-list/task_tclean/examples">tclean documentation
under examples</a>.</p>
<p>However, it is not a one-to-one mapping.  <tt class="docutils literal">tclean</tt> is not implemented using the exact script quoted
in the examples.  The differences are the variety that shouldn't matter but inevitably do.</p>
<p>I'm working on a translation of <tt class="docutils literal">tclean</tt>'s input parameters to
<tt class="docutils literal">pysynthesisimager</tt>'s, but it's not complete:
<a class="reference external" href="https://gist.github.com/keflavich/a9953c88cbe098b5e9bb4bdac6485f09">https://gist.github.com/keflavich/a9953c88cbe098b5e9bb4bdac6485f09</a></p>
<p>That was dumb anyway, because
<a class="reference external" href="https://github.com/radio-astro/casa/blob/master/gcwrap/python/scripts/task_tclean.py">https://github.com/radio-astro/casa/blob/master/gcwrap/python/scripts/task_tclean.py</a>
does everything I really needed.</p>
<p>My version saves the image, residual, and model at each major cycle.</p>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/casa-corrupted-measurement-sets.html" rel="bookmark" title="Permalink to CASA corrupted measurement sets">
                    CASA corrupted measurement sets</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2019-07-23T13:11:00-06:00"> 2019/07/23 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>Over the weekend, I had a huge quantity of ALMA data get corrupted. The
corruption appears to have been caused by an incorrectly-mounted lustre system
that had &quot;flock&quot; disabled.  When they re-mounted the filesystem, every
measurement set I had touched was unreadable.</p>
<p>Corrupted data sets had messages like this when opened with <tt class="docutils literal">msmd.open</tt>:</p>
<pre class="literal-block">
RuntimeError: Exception: Illegal DATA_DESC_ID value 30 found in main table. /lustre/cv/projects/ALMA_IMF/2017.1.01355.L/science_goal.uid___A001_X1296_X211/group.uid___A001_X1296_X212/member.uid___A001_X1296_X217/calibrated/uid___A002_Xcbdb2a_X6e67.ms.split.cal/DATA_DESCRIPTION only has 0 rows (IDs).
... thrown by void casa::MSChecker::checkReferentialIntegrity() const at File: ../../msvis/MSVis/MSChecker.cc, line: 78
</pre>
<p>The solution was to replace all of the <tt class="docutils literal">table.dat</tt> files in the
<tt class="docutils literal">DATA_DESCRIPTION</tt>, <tt class="docutils literal">POLARIZATION</tt>, <tt class="docutils literal">STATE</tt>, and <tt class="docutils literal">PROCESSOR</tt> folders
with &quot;backups&quot; from the parent measurement set.  Luckily, all of my data were
split from other measurement sets that still existed, and they were split with
<tt class="docutils literal">reindex=False</tt>, which meant that these tables were actually usable.  There's
no guarantee they would be in general.</p>
<p>My fix script is this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getdata</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">ii</span><span class="p">:(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="k">if</span> <span class="n">xx</span><span class="o">!=</span><span class="n">yy</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">fix_bad_mses</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fn</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.split.cal&quot;</span><span class="p">:</span>
                <span class="n">ffn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                <span class="n">workingfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;working&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workingfn</span><span class="p">):</span>
                    <span class="c1">#print(&quot;Working on files {0} and {1}&quot;.format(ffn, workingfn))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">ffn</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;PROCESSOR&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA_DESCRIPTION&#39;</span><span class="p">,</span> <span class="s1">&#39;STATE&#39;</span><span class="p">]:</span>
                        <span class="n">tbpth1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ffn</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="s1">&#39;table.dat&#39;</span><span class="p">)</span>
                        <span class="n">tbpth2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workingfn</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="s1">&#39;table.dat&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tbpth1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tbpth2</span><span class="p">):</span>
                            <span class="n">d1</span> <span class="o">=</span> <span class="n">getdata</span><span class="p">(</span><span class="n">tbpth1</span><span class="p">)</span>
                            <span class="n">d2</span> <span class="o">=</span> <span class="n">getdata</span><span class="p">(</span><span class="n">tbpth2</span><span class="p">)</span>
                            <span class="n">delta</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
                            <span class="c1">#print(&quot;Diff from {0} to {1} is {2}&quot;.format(tbpth1, tbpth2, delta))</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FIXING: Diff for </span><span class="si">{0}</span><span class="s2"> is </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">delta</span><span class="p">))</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tbpth1</span><span class="p">,</span> <span class="n">tbpth1</span><span class="o">+</span><span class="s2">&quot;.bck&quot;</span><span class="p">)</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tbpth2</span><span class="p">,</span> <span class="n">tbpth1</span><span class="p">)</span>
</pre></div>
<p>which spewed out a bunch of messages like this:</p>
<pre class="literal-block">
FIXING: Diff for POLARIZATION is {24: ('\x00', '\x01'), 1059: ('\x00', '\x01')}
FIXING: Diff for PROCESSOR is {24: ('\x00', '\x03'), 1078: ('\x00', '\x03')}
FIXING: Diff for DATA_DESCRIPTION is {24: ('\x00', '\x18'), 772: ('\x00', '\x18')}
FIXING: Diff for STATE is {24: ('\x00', '\x1d'), 1699: ('\x00', '\x1d')}
</pre>
<p>showing that for each bad file, two bytes were flipped.  I don't know how or why.  Notably, though,
the byte flips that corrupted the data did <em>not</em> change the file modification date - somehow CASA
hid this operation from the filesystem.</p>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/a-quick-performance-test-on-casa-cleaning.html" rel="bookmark" title="Permalink to A quick performance test on CASA cleaning">
                    A quick performance test on CASA cleaning</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2017-04-26T11:03:00-06:00"> 2017/04/26 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>I ran some speed tests to compare CASA's speed when imaging single channels vs
blocks of channels.  The tests were run with savemodel='none' on a lustre node</p>
<pre class="literal-block">
'speedtest_nchan1_concat': 249,
'speedtest_nchan1_individual': 523,
'speedtest_nchan5_concat': 803,
'speedtest_nchan5_individual': 916,
'speedtest_nchan20_concat': 2303,
'speedtest_nchan20_individual': 2346,
'speedtest_nchan40_concat': 4010,
'speedtest_nchan40_individual': 4136,
'speedtest_nchan80_concat': 8101,
'speedtest_nchan80_individual': 9298,
</pre>
<img alt="" src="https://keflavich.github.io/blog/images/casa/cube_performance.png" style="width: 600px;" />
<p>The fit is y = 98x + 237</p>
<p>So at least until swapping happens, there is no serious advantage or
disadvantage to running a different # of channels simultaneously.</p>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/casa-synthetic-observations.html" rel="bookmark" title="Permalink to CASA synthetic observations">
                    CASA synthetic observations</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2016-08-15T09:36:00-06:00"> 2016/08/15 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>To evaluate imaging robustness &amp; quality, it is necessary to do some sort of
synthetic observation.  These synthetic observations can be done on real
images, e.g. Herschel data shifted to greater distances, or on simulated data.</p>
<p>Some examples:</p>
<blockquote>
<ul class="simple">
<li><a class="reference external" href="https://github.com/keflavich/W51_ALMA_2013.1.00308.S/blob/master/analysis/synth_imaging_perseus.py">https://github.com/keflavich/W51_ALMA_2013.1.00308.S/blob/master/analysis/synth_imaging_perseus.py</a></li>
<li><a class="reference external" href="https://github.com/keflavich/W51_ALMA_2013.1.00308.S/blob/master/analysis/synth_imaging_perseus_2.py">https://github.com/keflavich/W51_ALMA_2013.1.00308.S/blob/master/analysis/synth_imaging_perseus_2.py</a></li>
<li><a class="reference external" href="https://github.com/keflavich/W51_ALMA_2013.1.00308.S/blob/master/analysis/synth_imaging_aquila.py">https://github.com/keflavich/W51_ALMA_2013.1.00308.S/blob/master/analysis/synth_imaging_aquila.py</a></li>
</ul>
</blockquote>
<p>General process:</p>
<blockquote>
<ol class="arabic simple">
<li>Import file into CASA .image form (e.g., <tt class="docutils literal">importfits</tt>)</li>
<li>Load the .ms file and replace visibilities w/fourier transform of image</li>
<li>Clean.</li>
</ol>
</blockquote>
<p>The hard part is setting up the files to be imported.</p>
<p>For example, you can import a FITS file, which to me seems to be the most
straightforward approach:</p>
<pre class="literal-block">
importfits(fitsimage=perseus_rescaled,
           imagename=perseus_casa_image,
           overwrite=True,
           defaultaxes=True,#['RA---TAN','DEC--TAN','FREQUENCY','STOKES'],
           defaultaxesvalues=['2.909234541667E+02deg',
                              '1.451177222222E+01deg',
                              '233.9468GHz','I'],
           # 18&quot; = 1.22 lambda/D
           beam=[&quot;{0}deg&quot;.format(18/3600.*distance_scaling),
                 &quot;{0}deg&quot;.format(18/3600.*distance_scaling),
                 &quot;0deg&quot;],
          )
</pre>
<p>The beam probably matters for Jy-&gt;K, or Jy/beam-&gt;Jy conversion.  The
<tt class="docutils literal">defaultaxesvalues</tt> should correspond to the pointing center of the
interferometer pointing or mosaic.</p>
<p>Next is bringing this image - which we now pray is in the correct units - into UV space.:</p>
<pre class="literal-block">
sm.openfromms(&quot;continuum_7m12m_noflag.ms&quot;)
sm.setvp()
success = sm.predict(perseus_casa_image)
assert success
# TODO: get these from ASDM_CALWVR and WEATHER
success2 = sm.setnoise(mode='tsys-atm', relhum=60.0, pwv='2mm', tatmos=265.0, )
success3 = sm.corrupt()
sm.done()
sm.close()
</pre>
<p>This snippet loads the .ms file (the visibilities), then overwrites them with
the fourier transform of the image using <tt class="docutils literal">sm.predict</tt>.  It's not clear whether
<tt class="docutils literal">setvp</tt> is necessary.  <tt class="docutils literal">setnoise</tt> + <tt class="docutils literal">corrupt</tt> just adds &quot;appropriate&quot;
atmospheric noise to the visibilities.</p>
<p>From there, you should just use the same <tt class="docutils literal">clean</tt> parameters as for the
original data, or try to optimize <tt class="docutils literal">clean</tt> here and use these parameters on
the real data.</p>
<p>The result will be the 'perfect' (no phase error, no amplitude error)
interferometric image.</p>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/casa-clean-splotchy-artifacts.html" rel="bookmark" title="Permalink to CASA clean: "splotchy" artifacts">
                    CASA clean: &quot;splotchy&quot; artifacts</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2016-06-14T09:31:00-06:00"> 2016/06/14 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>This image shows artifacts that look &quot;splotchy&quot;.  They are locations clean has
placed a negative model component where none belongs, so the residual is highly
positive and the resulting image is negative.</p>
<img alt="" src="https://keflavich.github.io/blog/images/casa/splotchy.png" style="width: 600px;" />
<p>Discussing with others, it appears that this artifact may be unique to
multiscale clean and therefore may be a result of a too-strong component being
added on a large scale.  It is not yet clear how to suppress these artifacts,
but I'm attempting to change the scales included.  Other ideas would be welcome
in the comments.</p>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/single-dish-combination-continued.html" rel="bookmark" title="Permalink to Single Dish Combination Continued">
                    Single Dish Combination Continued</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2016-06-02T16:59:00-06:00"> 2016/06/02 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>Continuing from yesterday, I've done some more analysis of my HC3N data on
different scales.  The first critical note is that there appears to be
disagreement between the 7m and 12m data.
In principle, smoothing the 12m data to the 7m resolution should at most
recover the 7m brightness; instead it seems that the 12m data significantly
overpredict the 7m brightness.</p>
<img alt="" src="https://keflavich.github.io/blog/images/sgrb2/array_imagecomparison.png" style="width: 600px;" />
<p>This discrepancy is also evident in the power spectra, where there appears to be missing flux
on 20-100 arcsecond scales.</p>
<img alt="" src="https://keflavich.github.io/blog/images/sgrb2/array_pspeccomparison.png" style="width: 600px;" />
<p>So maybe it's just that the 7m data are bad?</p>
<p>I discussed the image combination process with Baobab, and he suggested that it
may not be the flux calibration of the images (their absolute scaling) but the
relative weights used to combine them.  The default weights, and pretty much
all variants I had experimented with, use the single-dish beam as the starting
point: you weight the interferometer data by (1-SDbeam) in the fourier domain.</p>
<p>It turns out that, while this weighting scheme is the obvious thing to do
because the single-dish beam is well-characterized, it may not be the best.
The interferometer data may lose sensitivity on larger scales much faster than
(1-SDbeam) would suggest.</p>
<p>Carrying the single-dish weight down to smaller angular scales does a better
job of ensuring there are no negatives, but is it really &quot;right&quot;?
Unfortunately, there's no good answer to this; the process is essentially the
same as modifying the Briggs parameter when weighting intereferometric clean
data.  You just have to choose a scale, or a weighting function, and go with
it.  As long as the weights are conservative (i.e., sum to 1), the resulting
image should in some sense be correct.</p>
<img alt="" src="https://keflavich.github.io/blog/images/sgrb2/combination_weighting_scales.png" style="width: 600px;" />
<p>In that figure, the weighting scheme for the large angular scale data was set
to a series of different Gaussians.  The resolution of the 7m+TP data is
(theoretically) 24x11 arcseconds, but preserving the large angular scales below
the major beam axis seems to do a better job of preserving the image's
positivity.</p>
<p>The effect is more pronounced if we just combine the 12m+TP data, ignoring the
7m data (which might be wrong anyway).  For weighting FWHM above 30 arcseconds,
the interferometric data dominates the map.</p>
<img alt="" src="https://keflavich.github.io/blog/images/sgrb2/combination_weighting_scales_no7m.png" style="width: 600px;" />
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/single-dish-interferometer-combination-experiments.html" rel="bookmark" title="Permalink to Single Dish - Interferometer Combination Experiments">
                    Single Dish - Interferometer Combination Experiments</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2016-06-01T11:17:00-06:00"> 2016/06/01 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>I spent 3 days in Köln with Alvaro Sanchez-Mongé, Peter Schilke, Fanyi Meng,
and Anika Schmiedeke working on Sgr B2 data and specifically on trying to
combine the single dish (total power) data with my merged ACA+12m data from
ALMA program 2013.1.00269.S.</p>
<p>tl;dr: feathering appears to work fine, and many other methods work equally
well (assuming they can be implemented, which is uniformly harder).  Negative
bowls persisting after feathering are an indication of a problem with the input
data.</p>
<div class="section" id="feathering">
<h2>Feathering</h2>
<p>Fourier space combination of the single-dish and interferometric data is by
far the most straightforward to implement and the fastest.  However, in the HC3N
data, it left strong negative bowls, which should not be possible.</p>
<p>On the Einstein image, the image quality from feathering was not great, but
there were no negative bowls left.  The dynamic range is lower in the Einstein
data, but this still hints that there is a problem with the HC3N images.  We're
investigating the possibility that the 7m data are improperly calibrated or
weighted.</p>
</div>
<div class="section" id="miriad">
<h2>Miriad</h2>
<p>We never managed to create UV data from the single dish data because of complaints about
the pointing information.</p>
</div>
<div class="section" id="cleaning-with-a-single-dish-image-as-an-input-model">
<h2>Cleaning with a single dish image as an input model</h2>
<p>We attempted to clean the data using the single dish image as an input model.</p>
<p>On the real data, this failed with both tclean and clean.  With <tt class="docutils literal">tclean</tt>, there
was no error message, it just hung indefinitely.
With <tt class="docutils literal">clean</tt>, the error message is:</p>
<pre class="literal-block">
*** Error ***  LatticeExprNode - coordinates of operands mismatch
Scanned so far: modelos_0 + __temp_model2

2016-06-01 10:35:05     SEVERE  clean::::       An error occurred running task clean.
</pre>
<p>Changing CDELT to 1 GHz, which solved a previous issue, had no effect here.</p>
<p>It turns out <tt class="docutils literal">tclean</tt> will fail silently if it doesn't find the
<tt class="docutils literal">startmodel</tt>, which has to be specified as an image <em>prefix</em> for version
&lt;=4.6, and the image has to exist as a <tt class="docutils literal">.model</tt> file.  For higher versions, 4.6+,
the model can be directly referenced (as in clean).  Eventually, tclean seems to have
completed, though the results indicate that it does not treat the units as I expected;
the total power data seems to be over-weighted by a factor of 10^3+, probably by the ratio
of the beam areas:</p>
<img alt="" src="http://i.imgur.com/8dW7t8I.png" style="width: 600px;" />
<p>For the simulated images (einstein), we get the error:</p>
<pre class="literal-block">
2016-06-01 10:55:11 SEVERE  SynthesisImager::defineImage (file /Users/rpmbuild/gradle/workdir/casasources/release-4_5/code/synthesis/ImagerObjects/SynthesisImager.cc, line 668)    Error in adding Mapper : Error in createImStore : ::operator!= (const IPosition&amp;, const IPosition&amp;) - left and right operand do not conform
2016-06-01 10:55:11 SEVERE  tclean::task_tclean::   Exception from task_tclean : 2016-06-01 10:55:11        SEVERE  SynthesisImager::defineImage (file /Users/rpmbuild/gradle/workdir/casasources/release-4_5/code/synthesis/ImagerObjects/SynthesisImager.cc, line 668)    Error in adding Mapper : Error in createImStore : ::operator!= (const IPosition&amp;, const IPosition&amp;) - left and right operand do not conform
</pre>
<p>This is probably an issue with regridding.  <tt class="docutils literal">imregrid</tt> doesn't like our data:</p>
<pre class="literal-block">
2016-06-01 11:00:41 SEVERE  imregrid::image::regrid Exception Reported: Exception: The number of pixel axes in the output shape and Coordinate System must be the same. Shape has size 4. Output coordinate system has 3 axes.
2016-06-01 11:00:41 SEVERE  imregrid::image::regrid+        ... thrown by SPIIF casa::ImageRegridder::_regrid() const at File: /Users/rpmbuild/gradle/workdir/casasources/release-4_5/code/imageanalysis/ImageAnalysis/ImageRegridder.cc, line: 138
</pre>
<p>Adding a frequency axis to the FITS data (which was missing before...) seems to
have fixed this error for the Einstein data, but not for the real HC3N data.</p>
<!-- (this is now incorporated in an above paragraph) -->
<!-- tclean appears to use the wrong units for the input model, treating that model -->
<!-- very differently than ``clean`` does.  This error may be limited to CASA <= -->
<!-- 4.5, since the tclean documentation regarding models changed substantially from -->
<!-- 4.5 to 4.6. -->
</div>
<div class="section" id="linear-combination-in-image-space">
<h2>Linear Combination in Image Space</h2>
<p>Linear combination of the single dish and interferometer data in image space,
followed by image-space deconvolution, has been used successfully on HI data.
In principle, this is very straightforward, except for the need for
deconvolution.  CASA now has an image-space deconvolution program
(<tt class="docutils literal">deconvolve</tt>), so I was able to implement this approach.  However, the
deconvolver seems to only work on the inner 1/4 of the image in each dimension,
which left incomplete images that were difficult to compare.  Additionally,
CASA does not (obviously) carry the appropriate machinery for computing the
residual image and adding the convolved model back to the residual image.
Still, this is a promising route forward as it is computationally relatively
cheap and mostly easy to implement.</p>
<p>Linear combination is partly implemented now using the CASA <tt class="docutils literal">deconvolve</tt> task;
it hasn't been generalized but you can see the outline / single working case at
<a class="reference external" href="https://github.com/radio-astro-tools/uvcombine/blob/master/uvcombine/realspace_combine.py">this link</a>.</p>
<!-- this is how you include images -->
<!-- .. image:: |static|/images/psfFfftF.png -->
<!-- :width: 600px -->
</div>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/what-does-feather-do.html" rel="bookmark" title="Permalink to What does feather do?">
                    What does feather do?</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2016-05-26T08:29:00-06:00"> 2016/05/26 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>This is an examination of the 'feather' task in CASA.</p>
<p>First we have to track down what code is actually called.</p>
<p>On mac, this is:</p>
<blockquote>
<ul class="simple">
<li>/Applications/CASA.app/Contents/Resources/python/feather_cli.py -&gt; feather_cli</li>
<li>/Applications/CASA.app/Contents/Resources/python/task_feather.py -&gt; feather</li>
<li>/Applications/CASA.app/Contents/Resources/python/taskinit.py -&gt; imtool-&gt;imager-&gt;casac.imager-&gt;/Applications/CASA.app/Contents/Resources/python/feather_cli.py</li>
<li><a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Imager.cc#L2257">Imager.cc</a></li>
</ul>
</blockquote>
<p>Within the imager, <cite>setvp</cite> is used to do something with the primary beam.  As
far as I can tell, this function spews a lot of text into the logger, sets
local variables, sets one larger-scope variable <cite>BeamSquint::</cite>, then does
<cite>destroySkyEquation();</cite>.  In short, I don't know what this does.  Probably my
reading of the C code is incorrect and these variables are <em>not</em> local, in
which case it is just setting a bunch of default beam parameters.</p>
<p>Then, <cite>Imager.cc</cite> calls <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L1211">Feather.cc</a>.</p>
<p>Feather sets parameters based on the effective dish diameter.  It uses
<a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L244">1.22*(speed of light)/frequency/dish_diameter</a>,
so it is retrieving the FWHM
assuming a Gaussian beam by default.</p>
<p>A lovely aside: <cite>Imager.cc</cite> passes the local variable <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Imager.cc#L2320">lowPassFilterSD</a>
to <cite>Feather.cc</cite>, which is read in to the input boolean parameter
<a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L244">doHiPassFilterOnSD</a>.
That seems like a potential place for confusion.</p>
<p>If <cite>doHiPassFilterOnSD</cite> is set <em>or</em> the effective beam diameter is set as a
parameter, the single dish image is deconvolved with its beam using the
GaussianDeconvolver.  This is actually disabled by default, though.</p>
<p>The low resolution image is <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L142">regridded</a>
to match the high resolution image.</p>
<p>The <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L375">applyFeather</a>
command seems to do the actual work.
It starts with <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L414">calcCWeightImage</a>,
which sets the &quot;weight&quot; to one minus the peak-normalized fourier transform of
the low-resolution (single-dish) beam
<a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L427">Feather.cc line 427</a>,
with the result stored in the variable <cite>cwImage_p</cite>.
<a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L408">applyFeather</a> then just
multiplies the high-resolution image by this weight.</p>
<p>Back in the <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L695">saveFeatheredImage</a>
task, the single-dish data are fourier transformed, then a scaling factor, the ratio
between the low and high beam areas, is computed.  Finally, the single-dish
(scaled) and interferometer <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L694">fourier-transformed</a> images are <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L703">added</a>.</p>
<p>Is the single-dish image weighted by the beam at all?  The single-dish image will
be convolved with a kernel only if <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L1235">doHighPassFilterOnSD</a> is set
or if the effective dish diameter is set.  If the beam is the same size as the original
beam, nothing will happen.
In <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/synthesis/MeasurementEquations/Feather.cc#L256">setEffectiveDishDiam</a>
the low-resolution image is convolved with the <a class="reference external" href="https://github.com/radio-astro/casa/blob/160955adf4de4ee561cfc691904317953e08d7d6/code/components/ComponentModels/GaussianDeconvolver.cc#L34">*deconvolved*</a>
beam.</p>
<p>The most important note in this post is that the single-dish image is <em>not</em>
weighted unless <cite>doHighPassFilterOnSD</cite> is set, and even then nothing will be
done if the single-dish beam size passed as a parameter is the same as the beam
size specified in the header.  That means only the interferometer image is
weighted.  Maybe that is the correct behavior?  By weighting by (1-convolved
beam), which means setting the total flux in the interferometer image to zero,
the process is guaranteed to be flux conserving.</p>
<!-- this is how you include images -->
<!-- .. image:: |static|/images/psfFfftF.png -->
<!-- :width: 600px -->
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
    <li><article class="hentry">
        <header> 
            <h2 class="entry-title">
                <a href="https://keflavich.github.io/blog/casa-coordinate-defaults.html" rel="bookmark" title="Permalink to CASA coordinate defaults">
                    CASA coordinate defaults</a>
            </h2> 
        </header>
        <footer class="post-info">
            <abbr class="published" title="2016-05-19T09:31:00-06:00"> 2016/05/19 </abbr>
            <!--<address class="vcard author"><a class="url fn" href="https://keflavich.github.io/blog/author/adam-ginsburg-adamgginsburggmailcom.html">Adam Ginsburg (Adam.G.Ginsburg@gmail.com)</a></address>-->
        </footer><!-- /.post-info -->
        <div class="entry-content"> <p>A brief public service announcement: CASA coordinate strings follow a
convention of their own making that I at least find thoroughly
counterintuitive.  If you specify a sexagesimal coordinate, e.g. 05:12:15.3
-5:10:20.5 or something similar, CASA interprets that as 5 hours, -5 hours.
The declination is interpreted as being in hours.  Those are units no one has
ever used.  The CASA version requires the second half of the sexagesimal string
to be decimal separated:</p>
<pre class="literal-block">
2016-05-19 00:45:13     WARN    SynthesisParams::stringToMDirection (file /var/rpmbuild/BUILD/casa-prerelease/casa-prerelease-4.6.0/code/synthesis/ImagerObjects/SynthesisUtilMethods.cc, line 786)     You provided the Declination/Latitude value &quot;-28:23:29.22&quot; which is understood to be in units of hours.
2016-05-19 00:45:13     WARN    SynthesisParams::stringToMDirection (file /var/rpmbuild/BUILD/casa-prerelease/casa-prerelease-4.6.0/code/synthesis/ImagerObjects/SynthesisUtilMethods.cc, line 786)+    If you meant degrees, please replace &quot;:&quot; by &quot;.&quot;.
</pre>
<p>This has broken my scripts more than a handful of times now, since copying &amp;
pasting coordinates from any other program inevitably has the &quot;wrong&quot;
units.</p>
 </div>
        <!-- /.entry-content   not article.summary--> 
    </article></li>
    <hr width=100%>
</ul><!-- /#posts-list -->
<p class="paginator">
            <a href="https://keflavich.github.io/blog/tag/casa.html">&laquo;</a>
    Page 2 / 4
        <a href="https://keflavich.github.io/blog/tag/casa3.html">&raquo;</a>
</p>
</section><!-- /#content -->
  </div>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37306139-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37306139-1');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
  var disqus_shortname = 'adamginsburgsblog';
  (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
</script>
</body>
</html>
